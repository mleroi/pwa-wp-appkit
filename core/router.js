;define(function(require,exports){'use strict';var i=require('backbone'),l=require('underscore'),o=require('core/app-utils'),a=require('core/region-manager'),c=require('core/lib/hooks'),t=require('core/app'),p='',n='',s=function(e){var t=n.replace('#','');e=e.replace('#','');return t==e},u=function(e){var t='not_found';if(e==='/^(?:\?([\s\S]*))?$/'){t='default_route'}else if(e.indexOf('/^single')===0){t='single'}else if(e.indexOf('/^page')===0){t='page'}else if(e.indexOf('/^comments')===0){t='comments'}else if(e.indexOf('/^component')===0){t='component'}else if(e.indexOf('/^custom\-page')===0){t='custom-page'}else if(e==='/^([^?]*?)(?:\?([\s\S]*))?$/'){t='not_found'};return t};return i.Router.extend({routes:{'':'default_route','single/:global/:id':'single','page/:component_id/:page_id':'page','page/:page_id':'page_no_component','comments-:post_id':'comments','component-:id':'component','custom-page':'custom_page','single/:global/:id/':'single','page/:component_id/:page_id/':'page','comments-:post_id/':'comments','component-:id/':'component','custom-page/':'custom_page','*notFound':'not_found'},setDefaultRoute:function(e){p=e},getDefaultRoute:function(){return p},default_route:function(){this.navigate('/',{trigger:!0});this.execute_route_silently(p)},component:function(e){var i=this;n='component-'+e;var r=this.getRouteData('component',{component_id:e});if(r.error.length===0){if(s('component-'+e)){switch(r.screen_data.component_type){case'posts-list':a.show(r.view_type,r.view_data,r.screen_data);break;case'page':i.navigate(t.getScreenFragment('page',{component_id:e,item_id:r.screen_data.data.root_id}),{trigger:!0});break;case'hooks-list':case'hooks-no-global':a.show(r.view_type,r.view_data,r.screen_data);break;default:if(r.view_type!==''){a.show(r.view_type,r.view_data,r.screen_data)};break}}}else{o.log(r.error);t.router.default_route()}},single:function(e,r){n='single/'+e+'/'+r;var c=this,i=function(){var n=c.getRouteData('single',{item_global:e,item_id:r});if(n.error.length===0){if(s('single/'+e+'/'+r)){a.show(n.view_type,n.view_data,n.screen_data)}}else{o.log(n.error);t.router.default_route()}},l=t.globals[e];if(l){var p=l.get(r);if(p){i()}else{o.log('Router single route : item with id "'+r+'" not found in global "'+e+'".');t.loadRouteItemFromRemote(r,e,'posts-list',{success:function(e){i()},error:function(){t.router.default_route()}})}}else{o.log('Error : router single route : global "'+e+'" not found.');t.router.default_route()}},page:function(e,r){n='page/'+e+'/'+r;var i='pages',u=this,p=function(n){if(n==='wpak-page-component-placeholder'){var p=t.getPageComponentByPageId(l.get('id'),!0);if(p){n=p.id}};var i=u.getRouteData('page',{component_id:n,page_id:r});if(i.error.length===0){if(s('page/'+e+'/'+r)){a.show(i.view_type,i.view_data,i.screen_data)}}else{o.log(i.error);t.router.default_route()}},c=t.globals[i];if(c){var l=c.get(r);if(l){p(e)}else{o.log('Error : router : page route : item with id "'+r+'" not found in global "'+i+'".');t.loadRouteItemFromRemote(r,i,'page',{success:function(e,t){p(e,t.id)},error:function(){t.router.default_route()}})}}else{o.log('Error : router : screen route : global "'+i+'" not found.');t.router.default_route()}},page_no_component:function(e){this.page('wpak-page-component-placeholder',e)},comments:function(e){n='comments-'+e;function i(e,t,o){if(s('comments-'+t.id)){a.show('comments',{comments:e,post:t},{screen_type:'comments',component_id:'',item_id:parseInt(t.id),data:{item_global:o}})}};var r=t.comments.get(e);if(r){i(r.get('post_comments'),r.get('post'),r.get('item_global'))}else{t.getPostComments(e,function(e,t,o){i(e,t,o)},function(e){o.log('router.js error : App.getPostComments failed',e)})}},custom_page:function(){n='custom-page';var e=this.getRouteData('custom-page',{});if(e.error.length===0){if(s('custom-page')){a.show(e.view_type,e.view_data,e.screen_data)}}else{o.log(e.error);t.router.default_route()}},not_found:function(e){var r=this,o=c.applyFilters('fragment-not-found','#',[e]),a=t.getCustomRoute(e);if(!l.isEmpty(a)){o='';t.showCustomPage(a.template,a.data,e,!0)};if(o.length){r.navigate(o,{trigger:!0})}},getRouteTypeAndParameters:function(e){var t=null,r=i.history.getFragment(e),a=l.find(i.history.handlers,function(e){return e.route.test(r)});if(a){t={type:u(a.route.toString()),parameters:{}};var o=this._extractParameters(a.route,r);switch(t.type){case'default_route':t.parameters={};break;case'single':t.parameters={item_global:o[0],item_id:o[1]};break;case'page':t.parameters={component_id:o[0],page_id:o[1]};break;case'comments':t.parameters={post_id:o[0]};break;case'component':t.parameters={component_id:o[0]};break;case'custom-page':t.parameters={};break;case'not_found':t.parameters={fragment:o[0]};break}};return t},getRouteData:function(a,r){var e={view_type:'',view_data:{},screen_data:{},error:''};switch(a){case'default_route':break;case'single':var n=r.item_global;var m=r.item_id,l=t.globals[n];if(l){var s=l.get(m);if(s){var d=s.toJSON(),u=n=='posts'?{post:d}:{item:d};e.view_type='single';e.view_data={item:s,global:n};e.screen_data={screen_type:'single',component_id:'',component_type:'',item_id:parseInt(m),global:n,data:u,label:d.title}}else{e.error='Error : router single route : item with id "'+m+'" not found in global "'+n+'".'}}else{e.error='Error : router single route : global "'+n+'" not found.'};break;case'page':var i=r.component_id;var g=r.page_id,n='pages',l=t.globals[n];if(l){var s=l.get(g);if(s){var o=t.getComponentData(i);if(o){var u={post:s.toJSON(),is_tree_page:o.data.is_tree,is_tree_root:(g==o.data.root_id),root_id:o.data.root_id,root_depth:o.data.root_depth};e.view_type='page';e.view_data={item:s,global:n};e.screen_data={screen_type:'page',component_id:i,component_type:o.type,item_id:parseInt(g),global:n,data:u,label:u.post.title}}else{e.error='Error : router : page route : component with id "'+i+'" not found'}}else{e.error='Error : router : page route : item with id "'+g+'" not found in global "'+n+'".'}}else{e.error='Error : router : screen route : global "'+n+'" not found.'};break;case'comments':screen_data={};break;case'component':var i=r.component_id;var o=t.getComponentData(r.component_id);if(o){if(o.type==='posts-list'){e.view_type='posts-list';e.view_data=o.view_data;e.screen_data={screen_type:'list',component_type:o.type,component_id:i,item_id:0,global:o.global,data:o.data,label:o.label}}else if(o.type==='hooks-list'||o.type==='hooks-no-global'){e.view_type='hooks';e.view_data={component:o};e.screen_data={screen_type:'custom-component',component_type:o.type,component_id:i,item_id:0,global:o.global,data:o.data,label:o.label}}else{e=c.applyFilters('component-custom-type',e,[o])}}else{e.error='Error : component not found: "'+i+'"'};break;case'custom-page':var p=t.getCurrentCustomPage();if(p!==null){e.view_type='custom-page';e.view_data={custom_page:p};e.screen_data={screen_type:'custom-page',component_id:'',component_type:'',item_id:p.get('id'),data:{custom_page:p}}}else{e.error='Error : no current custom page found'};break;case'not_found':break};return e},execute_route_silently:function(e){var t=i.history.getFragment(e),a=l.find(i.history.handlers,function(e){return e.route.test(t)});if(a!==undefined){this.execute(a.callback,[t],'')}else{o.log('Router.js error: execute_route_silently: route not found.')}}})});